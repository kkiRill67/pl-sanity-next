name: Deploy to VDS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Validate required secrets
      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.SANITY_API_READ_TOKEN }}" ]; then
            echo "::error::SANITY_API_READ_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}" ]; then
            echo "::error::NEXT_PUBLIC_SANITY_PROJECT_ID secret is not set"
            exit 1
          fi
          echo "All required secrets are set"

      # 3️⃣ Build Docker image with secrets
      - name: Build Docker image
        run: |
          docker build \
            --build-arg SANITY_API_READ_TOKEN="${{ secrets.SANITY_API_READ_TOKEN }}" \
            --build-arg NEXT_PUBLIC_SANITY_PROJECT_ID="${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}" \
            --build-arg NEXT_PUBLIC_SANITY_DATASET="${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}" \
            --build-arg NEXT_PUBLIC_SANITY_API_VERSION="${{ secrets.NEXT_PUBLIC_SANITY_API_VERSION }}" \
            --build-arg NEXT_PUBLIC_SANITY_STUDIO_URL="${{ secrets.NEXT_PUBLIC_SANITY_STUDIO_URL }}" \
            -t bodymetrics:${{ github.sha }} .

      # 4️⃣ Save Docker image to file
      - name: Save Docker image
        run: docker save bodymetrics:${{ github.sha }} | gzip > bodymetrics.tar.gz

      # 5️⃣ Deploy to VDS
      - name: Deploy to VDS
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # дефолт, если секрет не задан или пустой
          DEPLOY_PATH="${DEPLOY_PATH:-/var/www/bodymetrics}"

          echo "DEPLOY_PATH (runner) = $DEPLOY_PATH"

          echo "Создание SSH-ключа..."
          echo "$SSH_KEY" | sed 's/\\n/\n/g' > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

          echo "Тестируем подключение..."
          ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
            "$SSH_USER@$SSH_HOST" "echo 'SSH OK'"

          SSH_OPTIONS="-i /tmp/deploy_key -o StrictHostKeyChecking=no"

          echo "Копируем Docker-образ на сервер..."
          scp $SSH_OPTIONS bodymetrics.tar.gz "$SSH_USER@$SSH_HOST:$DEPLOY_PATH/bodymetrics.tar.gz"

          echo "Разворачиваем контейнер на сервере..."
          ssh $SSH_OPTIONS "$SSH_USER@$SSH_HOST" DEPLOY_PATH="$DEPLOY_PATH" 'bash -s' << 'EOF'
            set -e

            echo "DEPLOY_PATH (server) = $DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            echo "Содержимое каталога перед docker load:"
            ls -la

            if [ ! -f bodymetrics.tar.gz ]; then
              echo "ОШИБКА: bodymetrics.tar.gz не найден в $DEPLOY_PATH"
              exit 1
            fi

            echo "Загружаем образ из bodymetrics.tar.gz..."
            docker load < bodymetrics.tar.gz

            echo "Список образов после load:"
            docker images | head -n 10

            echo "Определяем тег образа..."
            IMAGE_TAG=$(docker images bodymetrics --format '{{.Repository}}:{{.Tag}}' | head -n 1)

            if [ -z "$IMAGE_TAG" ]; then
              echo "ОШИБКА: не удалось найти образ bodymetrics после docker load"
              docker images | head -n 50
              exit 1
            fi

            echo "Используем образ: $IMAGE_TAG"

            echo "Пробуем запустить новый контейнер bodymetrics_new на 3001..."
            docker rm -f bodymetrics_new || true
            docker run -d \
              --name bodymetrics_new \
              --restart unless-stopped \
              -p 3001:3000 \
              "$IMAGE_TAG"

            echo "Ждём 10 секунд и проверяем, что новый контейнер жив..."
            sleep 10

            if ! docker ps --format '{{.Names}}' | grep -q '^bodymetrics_new$'; then
              echo "ОШИБКА: новый контейнер bodymetrics_new не запустился, откатываемся"
              docker logs bodymetrics_new || true
              docker rm -f bodymetrics_new || true
              exit 1
            fi

            echo "Проверяем HTTP-ответ нового контейнера..."
            if ! curl -fsS http://127.0.0.1:3001 >/dev/null 2>&1; then
              echo "ОШИБКА: новый контейнер bodymetrics_new не отвечает по HTTP, откатываемся"
              docker logs bodymetrics_new || true
              docker rm -f bodymetrics_new || true
              exit 1
            fi

            echo "Новый контейнер работает, переключаем трафик..."

            echo "Останавливаем и удаляем старый контейнер bodymetrics (если есть)..."
            docker stop bodymetrics || true
            docker rm bodymetrics || true

            echo "Запускаем новый контейнер как bodymetrics на 3000..."
            docker run -d \
              --name bodymetrics \
              --restart unless-stopped \
              -p 3000:3000 \
              "$IMAGE_TAG"

            echo "Удаляем временный контейнер bodymetrics_new..."
            docker rm -f bodymetrics_new || true

            echo "Чистим старые образы и архив..."
            docker image prune -af || true
            rm -f bodymetrics.tar.gz
          EOF

          rm -f /tmp/deploy_key bodymetrics.tar.gz
